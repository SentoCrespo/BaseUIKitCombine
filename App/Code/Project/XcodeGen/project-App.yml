# ---------------------------------
# Project target
# ---------------------------------

targets:
  Project:

    ## Scheme
    scheme:
      testTargets:
        - ProjectTests
      gatherCoverageData: true

    ## Properties
    type: application
    platform: [iOS]
    platformSuffix: ''
    
    ## Sources
    sources: 

      ### Autogeneration files
      # - path: AutoGenerated
      #   includes: 
      #     - "**/*.swift"

      # - path: AutoGenerated
      #   includes: 
      #     - "**/*.py"
      #   buildPhase: none

      # - path: AutoGenerated
      #   includes: 
      #     - Templates
      #   buildPhase: none

      ### Target files
      - path: Project
        excludes: 
          - Tests
          - "**/*_SPEC*.swift"
          - .swiftlint.yml
          - "**/*.swift.plist"
          - "**/*.config"
          - OtherResources/Info.plist
        
      ### Re-add info.plist without link
      - path: Project/OtherResources
        includes:
          - "Info.plist"
        buildPhase: none
        
      - path: Project
        includes: 
          - "**/*.config"
        buildPhase: none

      ### Files shared between two targets 
      ### Keeping their original path
      # - path: CarSharingTests/Classes
      #   includes: 
      #     - TestAppDelegate.swift
      #   createIntermediateGroups: true

      # - path: CarSharingUITests/Utils
      #   includes: 
      #     - AccessibilityIds.swift
      #   createIntermediateGroups: true

      ### Files added but not compiled
      - path: XcodeGen
        buildPhase: none
        
      - path: project.yml
        group: XcodeGen
        buildPhase: none
          
      ### Root single files 
      - path: CHANGELOG.md 
        buildPhase: none  

      - path: ./.swiftlint.yml
        buildPhase: none  

    ## Settings
    settings:
      base:
        SDKROOT: iphoneos
        PRODUCT_NAME: Project
        SWIFT_OBJC_BRIDGING_HEADER: $(SRCROOT)/Project/OtherResources/Project-Bridging-Header.h
        INFOPLIST_FILE: $(SRCROOT)/Project/OtherResources/Info.plist
        PRODUCT_BUNDLE_IDENTIFIER: com.sento.project
        # CODE_SIGN_ENTITLEMENTS: Project/Project.entitlements
        ENABLE_BITCODE: NO
        GCC_PREFIX_HEADER: Project/OtherResources/Project-Prefix.pch
        CLANG_ENABLE_MODULES: YES
        USER_HEADER_SEARCH_PATHS: ../AppSpecialisation/ExternSource
        SKIP_INSTALL: NO
        OTHER_LDFLAGS: "$(inherited) -ObjC"

      ### Specific settings
      configs:
        Debug:
          # to ignore non-Arm64 dependencies
          EXCLUDED_SOURCE_FILE_NAMES[sdk=iphonesimulator*]:
            # - sample.framework
          ASSETCATALOG_COMPILER_APPICON_NAME: AppIcon-Debug
          VALIDATE_WORKSPACE: NO
          ENABLE_TESTABILITY: YES
          OTHER_SWIFT_FLAGS: "$(inherited) -D DEBUG"
          CODE_SIGN_IDENTITY: iPhone Developer
          DEVELOPMENT_ASSET_PATHS: "Project/PreviewContent"
          
        Release:
          VALIDATE_WORKSPACE: YES
          ASSETCATALOG_COMPILER_APPICON_NAME: AppIcon-Release
          ASSETCATALOG_COMPILER_GENERATE_SWIFT_ASSET_SYMBOL_EXTENSIONS: YES
          CODE_SIGN_IDENTITY: iPhone Distribution

    ## Pre-build scripts phase
    preBuildScripts:

      ### Code generation with Sourcery
      - name: Code Autogeneration
        script: |
                echo 'Generating Code...'
                ${SRCROOT}/../../Scripts/CodeGeneration/autoGenerateCodeConfig.py \
                  --sourceryBin '${SRCROOT}/../../Scripts/CodeGeneration/Sourcery-1.6.0/bin/sourcery' \
                  --config '${SRCROOT}/Project/AutoGenerated/Autogeneration.config'
        basedOnDependencyAnalysis: false

      ### Enforce style conventions
      - name: Swift Lint
        script: |
                ${SRCROOT}/../../Scripts/CodeLinting/swiftlint-0.44.0 \
                  --config ${SRCROOT}/.swiftlint.yml
        basedOnDependencyAnalysis: false
    
    ## Post-build scripts phase
    postBuildScripts:

      ### Crash-report system
      # - name: Crashlytics
      #   script: |
      #           ${BUILD_DIR%/Build/*}/SourcePackages/checkouts/firebase-ios-sdk/Crashlytics/run
      #   inputFiles: [
      #     "${DWARF_DSYM_FOLDER_PATH}/${DWARF_DSYM_FILE_NAME}/Contents/Resources/DWARF/${TARGET_NAME}",
      #     "$(SRCROOT)/$(BUILT_PRODUCTS_DIR)/$(INFOPLIST_PATH)"
      #   ]
      #   basedOnDependencyAnalysis: false
      
    ## Dependencies
    dependencies:

      ### iOS SDKs
      - sdk: Foundation.framework
      - sdk: UIKit.framework
         
      ### Other targets
      - target: Domain
      - target: Data
      - target: Design
      - target: SharedUtils
      ### Swift Package Manager
